name:  build

permissions:
  contents: read

on:
  workflow_dispatch:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  swiftlint:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/realm/swiftlint:5.5-latest
    steps:
      # Copy repo to action runner
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      # Pull swiftlint image and run
      - name: Carry out swiftlint
        run: | 
          swiftlint --reporter github-actions-logging

  build:
    runs-on: ubuntu-latest
    needs: swiftlint 
    steps:
      # Copy repo to action runner
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # Install Swift and SDK
      - name: Install dependencies
        run: | 
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz && \
          tar zxf swiftly-$(uname -m).tar.gz && \
          ./swiftly init --quiet-shell-followup && \
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh" && \
          hash -r

          swift sdk install https://download.swift.org/swift-6.2.3-release/static-sdk/swift-6.2.3-RELEASE/swift-6.2.3-RELEASE_static-linux-0.0.1.artifactbundle.tar.gz \
          --checksum f30ec724d824ef43b5546e02ca06a8682dafab4b26a99fbb0e858c347e507a2c



      # Build binary
      - name: Build XS3 Cert Retrieval binary
        working-directory: ${{ github.workspace }}
        run: |
          swift build -c release --experimental-lto-mode=full --swift-sdk aarch64-swift-linux-musl
          echo "Checking aarch64-swift-linux-musl"
          ls -la .build/aarch64-swift-linux-musl/release/xs3-cert

          swift build -c release --experimental-lto-mode=full --swift-sdk x86_64-swift-linux-musl
          echo "Checking x86_64-swift-linux-musl"
          ls -la .build/x86_64-swift-linux-musl/release/xs3-cert

          echo "MD5SUM of xs3-cert ARM64 is $(md5sum ${{ github.workspace }}/.build/aarch64-swift-linux-musl/release/xs3-cert)"
          echo "MD5SUM of xs3-cert AMD64 is $(md5sum ${{ github.workspace }}/.build/x86_64-swift-linux-musl/release/xs3-cert)"

          


        